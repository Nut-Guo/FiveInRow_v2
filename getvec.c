/*
	Get the pieceid which consists of 4 numbers representing 
	the state in the 4 directions.
*/

#include "five_type.h"
#include "five_global.h"
#include <stdio.h>
#include <stdlib.h>

/*
	4 directions.
*/
typedef struct {
	uint16_t id[4];
}pieceid;

/*
	2 kinds of distance: to 4 and to 5;
	4 directions.
*/
typedef struct {
	uint8_t distance[2][4];
}distance;

typedef struct {
	uint8_t form[6];
}Disvec;

const uint8_t dis2four[1024] = 
{		
	   10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
	   10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
	   10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
	   10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,  3, 10,
		3, 10,  2, 10,  3, 10,  2, 10, 10, 10,  1, 10,  3, 10,  2, 10,  2,
	   10,  1, 10,  2, 10,  1, 10,  1, 10,  0, 10, 10, 10, 10, 10, 10, 10,
	   10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
	   10, 10, 10, 10, 10, 10, 10, 10, 20, 10, 10,  3, 10,  3,  3,  2, 10,
		3,  3,  2, 10,  2,  2,  1, 10,  3,  3,  2, 10,  2,  2,  1, 10,  2,
	   10,  1, 10,  1,  1,  0, 10,  3,  3, 10, 10,  2,  2, 10, 10,  2,  2,
	   10, 10,  1,  1, 10, 10,  2,  2, 10, 10,  1,  1, 10, 10,  1,  1, 10,
	   10,  0,  0, 10, 20, 10, 10,  3, 10,  3, 10,  2, 10,  3, 10,  2, 10,
	   10, 10,  1, 10,  3, 10,  2, 10,  2, 10,  1, 10,  2, 10,  1, 10,  1,
	   10,  0, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
	   10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 20,
	   20, 10, 10,  3, 10,  3,  3,  2, 10,  3,  3,  2,  3,  2,  2,  1, 10,
		3,  3,  2,  3,  2,  2,  1, 10,  2,  2,  1,  2,  1,  1,  0, 10,  3,
		3,  3,  3,  2,  2, 10, 10,  2,  2,  2,  2,  1,  1, 10, 10,  2,  2,
	   10, 10,  1,  1, 10, 10,  1,  1,  1,  1,  0,  0, 10, 20,  3,  3,  3,
		3,  3, 10,  2, 10,  2,  2,  2,  2, 10, 10,  1, 10,  2,  2,  2,  2,
		2, 10,  1, 10,  1,  1,  1,  1,  1, 10,  0, 10,  2,  2,  2,  2, 10,
	   10, 10, 10,  1,  1,  1,  1, 10, 10, 10, 10,  1,  1,  1,  1, 10, 10,
	   10, 10,  0,  0,  0,  0, 10, 10, 20, 20, 10, 10,  3, 10,  3,  3,  2,
	   10,  3,  3,  2, 10,  2,  2,  1, 10,  3,  3,  2, 10,  2,  2,  1, 10,
		2, 10,  1, 10,  1,  1,  0, 10,  3,  3, 10, 10,  2,  2, 10, 10,  2,
		2, 10, 10,  1,  1, 10, 10,  2,  2, 10, 10,  1,  1, 10, 10,  1,  1,
	   10, 10,  0,  0, 10, 20, 10, 10,  3, 10,  3, 10,  2, 10,  3, 10,  2,
	   10, 10, 10,  1, 10,  3, 10,  2, 10,  2, 10,  1, 10,  2, 10,  1, 10,
		1, 10,  0, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
	   10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 20, 20,
	   20, 20,
	   10, 10,  3, 10,  3,  3,  2, 10,  3,  3,  2,  3,  2,  2,  1, 10,  3,
		3,  2,  3,  2,  2,  1,  3,  2,  2,  1,  2,  1,  1,  0, 10,  3,  3,
		3,  3,  2,  2,  3,  3,  2,  2,  2,  2,  1,  1, 10, 10,  2,  2,  2,
		2,  1,  1,  2,  2,  1,  1,  1,  1,  0,  0, 10, 20,  3,  3,  3,  3,
		3,  3,  2,  3,  2,  2,  2,  2, 10, 10,  1, 10,  2,  2,  2,  2,  2,
		2,  1,  2,  1,  1,  1,  1,  1, 10,  0, 10,  2,  2,  2,  2, 10, 10,
	   10, 10,  1,  1,  1,  1, 10, 10, 10, 10,  1,  1,  1,  1,  1,  1,  1,
		1,  0,  0,  0,  0, 10, 10, 20, 20,  3,  3,  3,  3,  3,  3,  2,  3,
		3,  3,  2, 10,  2,  2,  1, 10,  2,  2,  2,  2,  2,  2,  1,  2,  2,
	   10,  1, 10,  1,  1,  0, 10,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
	   10, 10,  1,  1, 10, 10,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 10,
	   10,  0,  0, 10, 20,  2,  2,  2,  2,  2,  2,  2,  2,  3, 10,  2, 10,
	   10, 10,  1, 10,  1,  1,  1,  1,  1,  1,  1,  1,  2, 10,  1, 10,  1,
	   10,  0, 10,  1,  1,  1,  1,  1,  1,  1,  1, 10, 10, 10, 10, 10, 10,
	   10, 10,  0,  0,  0,  0,  0,  0,  0,  0, 10, 10, 10, 10, 20, 20, 20,
	   20, 10, 10,  3, 10,  3,  3,  2, 10,  3,  3,  2,  3,  2,  2,  1, 10,
		3,  3,  2,  3,  2,  2,  1, 10,  2,  2,  1,  2,  1,  1,  0, 10,  3,
		3,  3,  3,  2,  2, 10, 10,  2,  2,  2,  2,  1,  1, 10, 10,  2,  2,
	   10, 10,  1,  1, 10, 10,  1,  1,  1,  1,  0,  0, 10, 20,  3,  3,  3,
		3,  3, 10,  2, 10,  2,  2,  2,  2, 10, 10,  1, 10,  2,  2,  2,  2,
		2, 10,  1, 10,  1,  1,  1,  1,  1, 10,  0, 10,  2,  2,  2,  2, 10,
	   10, 10, 10,  1,  1,  1,  1, 10, 10, 10, 10,  1,  1,  1,  1, 10, 10,
	   10, 10,  0,  0,  0,  0, 10, 10, 20, 20, 10, 10,  3, 10,  3,  3,  2,
	   10,  3,  3,  2, 10,  2,  2,  1, 10,  3,  3,  2, 10,  2,  2,  1, 10,
		2, 10,  1, 10,  1,  1,  0, 10,  3,  3, 10, 10,  2,  2, 10, 10,  2,
		2, 10, 10,  1,  1, 10, 10,  2,  2, 10, 10,  1,  1, 10, 10,  1,  1,
	   10, 10,  0,  0, 10, 20, 10, 10,  3, 10,  3, 10,  2, 10,  3, 10,  2,
	   10, 10, 10,  1, 10,  3, 10,  2, 10,  2, 10,  1, 10,  2, 10,  1, 10,
		1, 10,  0, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
	   10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 20, 20, 20, 20, 20, 20,
	   20, 20
};

const uint8_t dis2five[1024] =
{
		10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
	   10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,  4,
		4,  3,  4,  3,  3,  2,  4,  3,  3,  2,  3,  2,  2,  1,  4,  3,  3,
		2,  3,  2,  2,  1,  3,  2,  2,  1,  2,  1,  1,  0, 10,  4,  4,  3,
		4,  3,  3,  2,  4,  3,  3,  2,  3,  2,  2,  1,  4,  3,  3,  2,  3,
		2,  2,  1,  3,  2,  2,  1,  2,  1,  1,  0,  4,  4,  3,  3,  3,  3,
		2,  2,  3,  3,  2,  2,  2,  2,  1,  1,  3,  3,  2,  2,  2,  2,  1,
		1,  2,  2,  1,  1,  1,  1,  0, 20, 10,  4,  4,  3,  4,  3,  3,  2,
		4,  3,  3,  2,  3,  2,  2,  1,  4,  3,  3,  2,  3,  2,  2,  1,  3,
		2,  2,  1,  2,  1,  1,  0,  4,  4,  3,  3,  3,  3,  2,  2,  3,  3,
		2,  2,  2,  2,  1,  1,  3,  3,  2,  2,  2,  2,  1,  1,  2,  2,  1,
		1,  1,  1,  0, 20,  4,  4,  4,  3,  3,  3,  3,  2,  3,  3,  3,  2,
		2,  2,  2,  1,  3,  3,  3,  2,  2,  2,  2,  1,  2,  2,  2,  1,  1,
		1,  1,  0,  3,  3,  3,  3,  2,  2,  2,  2,  2,  2,  2,  2,  1,  1,
		1,  1,  2,  2,  2,  2,  1,  1,  1,  1,  1,  1,  1,  1,  0,  0, 20,
	   20, 10,  4,  4,  3,  4,  3,  3,  2,  4,  3,  3,  2,  3,  2,  2,  1,
		4,  3,  3,  2,  3,  2,  2,  1,  3,  2,  2,  1,  2,  1,  1,  0,  4,
		4,  3,  3,  3,  3,  2,  2,  3,  3,  2,  2,  2,  2,  1,  1,  3,  3,
		2,  2,  2,  2,  1,  1,  2,  2,  1,  1,  1,  1,  0, 20,  4,  4,  4,
		3,  3,  3,  3,  2,  3,  3,  3,  2,  2,  2,  2,  1,  3,  3,  3,  2,
		2,  2,  2,  1,  2,  2,  2,  1,  1,  1,  1,  0,  3,  3,  3,  3,  2,
		2,  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  2,  2,  2,  2,  1,  1,
		1,  1,  1,  1,  1,  1,  0,  0, 20, 20,  4,  4,  4,  3,  4,  3,  3,
		2,  3,  3,  3,  2,  3,  2,  2,  1,  3,  3,  3,  2,  3,  2,  2,  1,
		2,  2,  2,  1,  2,  1,  1,  0,  3,  3,  3,  3,  3,  3,  2,  2,  2,
		2,  2,  2,  2,  2,  1,  1,  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,
		1,  1,  1,  1,  0, 20,  3,  3,  3,  3,  3,  3,  3,  2,  2,  2,  2,
		2,  2,  2,  2,  1,  2,  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  1,
		1,  1,  1,  0,  2,  2,  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  1,
		1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  0,  0,  0,  0, 20, 20,
	   20, 20,
	   10,  4,  4,  3,  4,  3,  3,  2,  4,  3,  3,  2,  3,  2,  2,  1,  4,
		3,  3,  2,  3,  2,  2,  1,  3,  2,  2,  1,  2,  1,  1,  0,  4,  4,
		3,  3,  3,  3,  2,  2,  3,  3,  2,  2,  2,  2,  1,  1,  3,  3,  2,
		2,  2,  2,  1,  1,  2,  2,  1,  1,  1,  1,  0, 20,  4,  4,  4,  3,
		3,  3,  3,  2,  3,  3,  3,  2,  2,  2,  2,  1,  3,  3,  3,  2,  2,
		2,  2,  1,  2,  2,  2,  1,  1,  1,  1,  0,  3,  3,  3,  3,  2,  2,
		2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  2,  2,  2,  2,  1,  1,  1,
		1,  1,  1,  1,  1,  0,  0, 20, 20,  4,  4,  4,  3,  4,  3,  3,  2,
		3,  3,  3,  2,  3,  2,  2,  1,  3,  3,  3,  2,  3,  2,  2,  1,  2,
		2,  2,  1,  2,  1,  1,  0,  3,  3,  3,  3,  3,  3,  2,  2,  2,  2,
		2,  2,  2,  2,  1,  1,  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  1,
		1,  1,  1,  0, 20,  3,  3,  3,  3,  3,  3,  3,  2,  2,  2,  2,  2,
		2,  2,  2,  1,  2,  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  1,  1,
		1,  1,  0,  2,  2,  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  1,  1,
		1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  0,  0,  0,  0, 20, 20, 20,
	   20,  4,  4,  4,  3,  4,  3,  3,  2,  4,  3,  3,  2,  3,  2,  2,  1,
		3,  3,  3,  2,  3,  2,  2,  1,  3,  2,  2,  1,  2,  1,  1,  0,  3,
		3,  3,  3,  3,  3,  2,  2,  3,  3,  2,  2,  2,  2,  1,  1,  2,  2,
		2,  2,  2,  2,  1,  1,  2,  2,  1,  1,  1,  1,  0, 20,  3,  3,  3,
		3,  3,  3,  3,  2,  3,  3,  3,  2,  2,  2,  2,  1,  2,  2,  2,  2,
		2,  2,  2,  1,  2,  2,  2,  1,  1,  1,  1,  0,  2,  2,  2,  2,  2,
		2,  2,  2,  2,  2,  2,  2,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
		1,  1,  1,  1,  1,  1,  0,  0, 20, 20,  3,  3,  3,  3,  3,  3,  3,
		2,  3,  3,  3,  2,  3,  2,  2,  1,  2,  2,  2,  2,  2,  2,  2,  1,
		2,  2,  2,  1,  2,  1,  1,  0,  2,  2,  2,  2,  2,  2,  2,  2,  2,
		2,  2,  2,  2,  2,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
		1,  1,  1,  1,  0, 20,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,
		2,  2,  2,  2,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
		1,  1,  1,  0,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,
		1,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0, 20, 20, 20, 20, 20, 20,
	   20, 20
};

extern inline uint8_t verify_location(Point p);
// move one step in the specific direction
extern inline void move(Point* p, uint8_t i, uint8_t j) {
	(*p).x += dx[i] * direction[j];
	(*p).y += dy[i] * direction[j];
}

uint8_t len[2];
uint16_t line[2];
// look up the end in one direction.
inline uint16_t parse_line(Point p, uint8_t i, uint8_t color, Board *local_board) {// look up the end in one direction.
	Point tmpp = p;
	uint16_t line = 1;
	uint8_t len[2] = { 0 };
	move(&p, i, 0);
	while (verify_location(p) && ((*local_board).location[p.x][p.y] == color || (*local_board).location[p.x][p.y] > 3) && len[0] < 4) {
		line = (line << 1) + ((*local_board).location[p.x][p.y] == color);
		++len[0];
		move(&p, i, 0);
	}
	move(&tmpp, i, 1);
	while (verify_location(tmpp) && ((*local_board).location[tmpp.x][tmpp.y] == color || (*local_board).location[tmpp.x][tmpp.y] > 3) && len[1] < 4) {
		line ^= (((*local_board).location[tmpp.x][tmpp.y] == color) << (len[0] + len[1] + 1));
		++len[1];
		move(&tmpp, i, 1);
	}
	line ^= (1 << (len[0] + len[1] + 1));
	return line;
}

//The function that calls the former ones that to get the id.
inline pieceid lookup(Point p, uint8_t color, Board *local_board) {
	uint8_t save = (*local_board).location[p.x][p.y];
	(*local_board).location[p.x][p.y] = color;
	pieceid id = {0};
	for (uint8_t i = 0; i < 4; i++) {// look up in the four directions;
		id.id[i] = parse_line(p, i, color, local_board);
	}
	(*local_board).location[p.x][p.y] = save;
	return id;
}

//Translate id 2 distance
inline distance id2dis(Point p, uint8_t color, Board *local_board) {
	pieceid id = lookup(p, color,local_board);
	distance dis;
	for (uint8_t i = 0; i < 4; i++) {
		dis.distance[0][i] = dis2four[id.id[i]];
		dis.distance[1][i] = dis2five[id.id[i]];
	}
	return dis;
}

uint8_t mini[2];//store the min direction of 4 and 5;
inline void selection_sort(uint8_t a[], uint8_t len, uint8_t id)
{
	uint8_t i, j, temp;
	for (i = 0; i < 2; i++)
	{
		uint8_t min = i;
		for (j = i + 1; j < len; j++)
		{
			if (a[j] < a[min])
			{
				min = j;
			}
		}
		if (min != i)
		{
			temp = a[min];
			a[min] = a[i];
			a[i] = temp;
		}
		if (i == 0) mini[id] = min;
	}
}

extern inline Disvec getvec(Point p, uint8_t color, Board *local_board) {
	distance dis = id2dis(p,color,local_board);
	//sort the dis;
	uint8_t mindis40 = 10;
	uint8_t mindis41 = 10;
	uint8_t mindis50 = 10;
	uint8_t mindis51 = 10;
	uint8_t i40 = 4;
	uint8_t i50 = 4;
	uint8_t longline = 20;
	for (uint8_t i = 0; i < 4; i++) {
		if (dis.distance[0][i] == 20) {
			longline = 0;
			break;
		}
	}
	selection_sort(dis.distance[0], 4, 0);
	selection_sort(dis.distance[1], 4, 1);
	mindis40 = dis.distance[0][0];
	mindis41 = dis.distance[0][1];
	mindis50 = dis.distance[1][0];
	mindis51 = dis.distance[1][1];
	i40 = mini[0];
	i50 = mini[1];
	//calc double 3
	uint8_t mindisd3 = (mindis40 ? mindis40 - 1 : 0) + (mindis41 ? mindis41 - 1 : 0);
	//calc 4 and 3
	uint8_t mindis34 = i40 == i50 ? min((mindis40 ? mindis40 - 1 : 0) + (mindis51 ? mindis51 - 1 : 0), (mindis41 ? mindis41 - 1 : 0) + (mindis50 ? mindis50 - 1 : 0)) : ((mindis40 ? mindis40 - 1 : 0) + (mindis50 ? mindis50 - 1 : 0));
	//calc double 4
	uint8_t mindisd4 = (mindis50 ? mindis50 - 1 : 0) + (mindis51 ? mindis51 - 1 : 0);
	if (!mindis50) {
		mindisd4 = 10;
		mindis34 = 10;
		mindisd3 = 10;
	}
	if (!mindisd4) {
		mindisd3 = 10;
		mindis34 = 10;
	}
	if (!mindis34) {
		mindisd3 = 10;
	}
	Disvec vec = { { mindis50,mindis40,mindis34,mindisd4,mindisd3,longline} };
	return vec;
}